# This is a workflow to being called from appdev-devops repo in genesiscicd
#  NPM web build workflow v0.0.1

name: Site Deploy

on:
  workflow_call:
    inputs:
      repo_name:
        required: true
        type: string
      branch:
        required: false
        type: string
      product_name:
        required: false
        type: string

    secrets:
      JFROG_USERNAME:
        required: true
      JFROG_EMAIL:
        required: true
      JFROG_PASSWORD:
        required: true

env:
  REPO_NAME: ${{ inputs.repo_name }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    env:
      JFROG_USERNAME: ${{secrets.JFROG_USERNAME}}
      JFROG_EMAIL: ${{secrets.JFROG_EMAIL}}
      JFROG_PASSWORD: ${{secrets.JFROG_PASSWORD}}
      GITTAG: ${{ github.ref_name }}
    runs-on: appdev-selfhosted

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: '0'

      - name: Env Variable Setup for nightly builds off default-branch
        if: ${{ inputs.branch == 'develop' ||  inputs.branch == 'main' ||  inputs.branch == 'master' || inputs.branch == '0.0.0' }}
        run: |
              echo "PRODUCT_BASE=$(pwd)" >> $GITHUB_ENV
              echo "PRODUCT_NAME=$(git config --get remote.origin.url | cut -d"." -f2 | cut -d"/" -f3 | cut -d"-" -f1 | cut -d"_" -f2)" >> $GITHUB_ENV #NOTE: only works with SSH repo urls + will cause issues with bny_investments
              echo "VERSION=${{ inputs.branch }}" >> $GITHUB_ENV
              echo "The current location is :"
              pwd
              for i in ./*
              do
                  if [ "$i" == "./snt" ]
                  then
                    WEB_VERSION=$(grep "web_version" $(find $i -name product.yml) | awk -F ':' '{print $2}' | sed 's/ //g')
                    SERVER_VERSION=$(grep server_version $(find  $i -name product.yml) |  awk -F ':' '{print $2}'| sed 's/ //g')
                  else
                    echo "$i not a client directory"
                 fi
              done
              echo "OUTPUT=$(git config --get remote.origin.url | cut -d"." -f2 | cut -d"/" -f3 | cut -d"-" -f1 | cut -d"_" -f2)-site-specific-${{ inputs.branch }}.zip" >> $GITHUB_ENV
              [[ ! -z "$WEB_VERSION" ]] && echo "WEB_VERSION=${{ inputs.branch }}" >> $GITHUB_ENV
              [[ ! -z "$SERVER_VERSION" ]] && echo "SERVER_VERSION=${{ inputs.branch }}" >> $GITHUB_ENV

      - name: Env Variable setup for auth and genesis fw versions
        run: |
             set +x -e
             curl -sSf -u ${{ secrets.JFROG_USERNAME }}:"${{secrets.JFROG_PASSWORD}}" -LO 'https://genesisglobal.jfrog.io/artifactory/product/${{ env.PRODUCT_NAME }}/server/pom-${{ env.SERVER_VERSION }}.xml'
             echo pom-${{ env.SERVER_VERSION }}.xml
             echo "AUTH_VERSION=$(echo "$(echo "$(grep -m 1 "<auth.version>" $(find . -maxdepth 1 -name pom-${{env.SERVER_VERSION}}.xml) | sed -n 's:.*<auth.version>\(.*\)</auth.version>.*:\1:p')")")" >> $GITHUB_ENV
             echo "GENESIS_VERSION=$(echo "$(echo "$(grep -m 1 "<genesis.version>" $(find . -maxdepth 1 -name pom-${{env.SERVER_VERSION}}.xml) | sed -n 's:.*<genesis.version>\(.*\)</genesis.version>.*:\1:p')")")" >> $GITHUB_ENV

      - name: Env Setup for PRODUCT_NAME for repos not following a conventions
        if: ${{ inputs.product_name }}
        run: |
              echo "PRODUCT_NAME=${{ inputs.product_name }}" >> $GITHUB_ENV #NOTE: only for those that are not following a standard naming convention

      - name: check env variables
        run: |
              echo "$(git describe --tags)"
              echo "Product Name: ${{ env.PRODUCT_NAME }}"
              echo "Version: ${{ env.VERSION }}"
              echo "Product Base: ${{ env.PRODUCT_BASE }}"
              echo "Output: ${{ env.OUTPUT }}"
              echo "SERVER_VERSION: ${{ env.SERVER_VERSION }}"
              echo "WEB_VERSION: ${{ env.WEB_VERSIOB }}"
              echo "AUTH_VERSION: ${{ env.AUTH_VERSION }}"
              echo "GENESIS_VERSION fw : ${{ env.GENESIS_VERSION }}"

      - name: Download genesis_framework, pom, server artifacts
        run: |
             set +x -e
             #download auth distribution into server_downloads folder
             mkdir distros
             wget --user=${{ secrets.JFROG_USERNAME }} --password="${{secrets.JFROG_PASSWORD}}" -P "${{env.PRODUCT_BASE}}/distros" https://genesisglobal.jfrog.io/artifactory/libs-release-local/global/genesis/auth-distribution/"${{env.AUTH_VERSION}}"/auth-distribution-"${{env.AUTH_VERSION}}"-bin.zip
             #download genesis framework
             wget --user=${{ secrets.JFROG_USERNAME }} --password="${{secrets.JFROG_PASSWORD}}" -P "${{env.PRODUCT_BASE}}/distros" https://genesisglobal.jfrog.io/artifactory/libs-release-local/global/genesis/genesis-distribution/"${{ env.GENESIS_VERSION }}"/genesis-distribution-"${{ env.GENESIS_VERSION }}"-bin.zip
             #download server into server_downloads folder
             wget --user=${{ secrets.JFROG_USERNAME }} --password="${{secrets.JFROG_PASSWORD}}" -P "${{env.PRODUCT_BASE}}/distros"  https://genesisglobal.jfrog.io/artifactory/product/"${{ env.PRODUCT_NAME }}"/server/genesisproduct-"${{ env.PRODUCT_NAME }}"-"${{ env.SERVER_VERSION }}"-bin.zip


      - name: Package + Deploy Site per client
        run: |
             sudo yum install zip -y
             sudo yum install rpmdevtools -y
             cd ${{ env.PRODUCT_BASE }}
             echo "This is the base directory->" && echo "$(pwd)"
             for i in ./*
              do
                if [ "$i" == "./snt" ]
                then
                    CLIENT_DIR=""
                    CLIENT_NAME="genesis"
                    echo "Client directory is empty-->" && echo "$CLIENT_DIR"
                    echo "Client name is-->" && echo "$CLIENT_NAME"
                    echo "Create client specific server downloads dir for rpm creation-->" && mkdir "$CLIENT_NAME"_server_downloads
                    echo "Create client specific web downloads dir for rpm creation-->" && mkdir "$CLIENT_NAME"_web_downloads
                    echo "Change location to the client specific src directory-->" && cd ${{ env.PRODUCT_BASE }}/src
                    echo "Create and upload artifact contaiing files from src/site-specific/ usually cfg and assembly folders to jfrog"
                    zip -r ${{ env.PRODUCT_BASE }}/snt/${{ env.OUTPUT }} site-specific/*
                    curl -u ${{ secrets.JFROG_USERNAME }}:"${{secrets.JFROG_PASSWORD}}" -X PUT "https://genesisglobal.jfrog.io/artifactory/product/${{ env.PRODUCT_NAME }}/site/$CLIENT_NAME/${{env.OUTPUT}}" -T ${{ env.PRODUCT_BASE }}/snt/${{env.OUTPUT}}
                    cp ${{ env.PRODUCT_BASE }}/snt/${{env.OUTPUT}} ${{env.PRODUCT_BASE}}/"$CLIENT_NAME"_server_downloads
                    cd ${{ env.PRODUCT_BASE }}
                    if [[ $(grep -c "genesis_modules" ./snt/product.yml) -ge 1 ]]; then
                        set +x -e
                        echo "$(sed -e '1,/genesis_modules/d'  < ./snt/product.yml | grep "^  - { ")" > /tmp/"$CLIENT_NAME"_edited_product.yml
                        while read line
                          do
                            echo "Reading this line from product.yml now  -- $line"
                            wget --user=${{ secrets.JFROG_USERNAME }} --password="${{secrets.JFROG_PASSWORD}}" -P ${{env.PRODUCT_BASE}}/"$CLIENT_NAME"_server_downloads https://genesisglobal.jfrog.io/artifactory/product/$((grep -oP '(?<=name:).*?(?=,)' <<< $line)|awk '$1=$1')/server/genesisproduct-$((grep -oP '(?<=name:).*?(?=,)' <<< $line) | awk '$1=$1')-$((grep -oP '(?<=version: )[^ ]*' <<< $line)|awk '$1=$1' )-bin.zip
                          done < /tmp/"$CLIENT_NAME"_edited_product.yml
                        echo "Modules required for $CLIENT_NAME required are-->" && cat /tmp/"$CLIENT_NAME"_edited_product.yml
                        rm /tmp/"$CLIENT_NAME"_edited_product.yml
                    fi
                    cd ${{ env.PRODUCT_BASE }}
                    if [ "${{ env.WEB_VERSION }}" == "" ]; then
                      echo "Product Name: ${{ env.PRODUCT_NAME }} does not have a requirement for web, creating an empty zipped up folder for deployment requirements"
                      cd "$CLIENT_NAME"_web_downloads
                      touch temp
                      tar czvf /tmp/genesis_${{ env.PRODUCT_NAME }}_web.tar.gz *
                      cd ../"$CLIENT_NAME"_server_downloads
                    else
                      cd "$CLIENT_NAME"_web_downloads
                      wget --user=${{ secrets.JFROG_USERNAME }} --password="${{ secrets.JFROG_PASSWORD }}" -P ${{ env.PRODUCT_BASE }}/"$CLIENT_NAME"_web_downloads https://genesisglobal.jfrog.io/artifactory/product/"${{ env.PRODUCT_NAME }}"/web/"${{ env.PRODUCT_NAME }}"-web-"${{ env.WEB_VERSION }}".zip
                      unzip \*.zip
                      tar czvf /tmp/genesis_${{ env.PRODUCT_NAME }}_web.tar.gz *
                      cd ../"$CLIENT_NAME"_server_downloads
                    fi
                    cp -r ${{env.PRODUCT_BASE}}/distros/*   ${{env.PRODUCT_BASE}}/"$CLIENT_NAME"_server_downloads/
                    unzip \*.zip
                    rm *.zip
                    tar czvf /tmp/genesis_${{env.PRODUCT_NAME}}_package.tar.gz *
                    echo "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHByb2plY3QgeG1sbnM9Imh0dHA6Ly9tYXZlbi5hcGFjaGUub3JnL1BPTS80LjAuMCIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIKICAgICAgICAgeHNpOnNjaGVtYUxvY2F0aW9uPSJodHRwOi8vbWF2ZW4uYXBhY2hlLm9yZy9QT00vNC4wLjAgaHR0cDovL21hdmVuLmFwYWNoZS5vcmcveHNkL21hdmVuLTQuMC4wLnhzZCI+CiAgICA8bW9kZWxWZXJzaW9uPjQuMC4wPC9tb2RlbFZlcnNpb24+CiAgICA8Z3JvdXBJZD5nbG9iYWwuZ2VuZXNpczwvZ3JvdXBJZD4KICAgIDxhcnRpZmFjdElkPmdlbmVzaXMtcnBtPC9hcnRpZmFjdElkPgogICAgPHZlcnNpb24+MS4wLjA8L3ZlcnNpb24+CiAgICA8cGFja2FnaW5nPnBvbTwvcGFja2FnaW5nPgogICAgPG5hbWU+Z2VuZXNpcy1ycG08L25hbWU+CiAgICA8cHJvcGVydGllcz4KCQk8cHJvamVjdC5idWlsZC5zb3VyY2VFbmNvZGluZz5VVEYtODwvcHJvamVjdC5idWlsZC5zb3VyY2VFbmNvZGluZz4KCTwvcHJvcGVydGllcz4KICAgIDxtb2R1bGVzLz4KICAgIDxidWlsZD4KICAgICAgICA8cGx1Z2lucz4KICAgICAgICAgICAgPHBsdWdpbj4KICAgICAgICAgICAgICAgIDxncm91cElkPm9yZy5jb2RlaGF1cy5tb2pvPC9ncm91cElkPgogICAgICAgICAgICAgICAgPGFydGlmYWN0SWQ+cnBtLW1hdmVuLXBsdWdpbjwvYXJ0aWZhY3RJZD4KICAgICAgICAgICAgICAgIDx2ZXJzaW9uPjIuMi4wPC92ZXJzaW9uPgogICAgICAgICAgICAgICAgPGluaGVyaXRlZD5mYWxzZTwvaW5oZXJpdGVkPgogICAgICAgICAgICAgICAgPGNvbmZpZ3VyYXRpb24+CiAgICAgICAgICAgICAgICAgICAgPG5hbWU+Z2VuZXNpcy1QUk9EVUNUPC9uYW1lPgogICAgICAgICAgICAgICAgICAgIDxsaWNlbnNlPihjKSBnZW5lc2lzLmdsb2JhbDwvbGljZW5zZT4KICAgICAgICAgICAgICAgICAgICA8bmVlZGFyY2g+eDg2XzY0PC9uZWVkYXJjaD4KICAgICAgICAgICAgICAgICAgICA8Z3JvdXA+R2VuZXNpcyBQbGF0Zm9ybTwvZ3JvdXA+CiAgICAgICAgICAgICAgICAgICAgPHBvc3RpbnN0YWxsU2NyaXB0bGV0PgogICAgICAgICAgICAgICAgICAgICAgICA8c2NyaXB0RmlsZT4vdG1wL2luc3RhbGwuc2g8L3NjcmlwdEZpbGU+CiAgICAgICAgICAgICAgICAgICAgPC9wb3N0aW5zdGFsbFNjcmlwdGxldD4KICAgICAgICAgICAgICAgICAgICA8bWFwcGluZ3M+CiAgICAgICAgICAgICAgICAgICAgICAgIDxtYXBwaW5nPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpcmVjdG9yeT4vdG1wLzwvZGlyZWN0b3J5PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGZpbGVtb2RlPjc1MDwvZmlsZW1vZGU+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dXNlcm5hbWU+cm9vdDwvdXNlcm5hbWU+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Z3JvdXBuYW1lPnJvb3Q8L2dyb3VwbmFtZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzb3VyY2VzPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzb3VyY2U+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsb2NhdGlvbj4vdG1wL2dlbmVzaXNfUFJPRFVDVF9wYWNrYWdlLnRhci5nejwvbG9jYXRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zb3VyY2U+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NvdXJjZXM+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvbWFwcGluZz4KICAgICAgICAgICAgICAgICAgICAgICAgPG1hcHBpbmc+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGlyZWN0b3J5Pi90bXAvPC9kaXJlY3Rvcnk+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZmlsZW1vZGU+NzUwPC9maWxlbW9kZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx1c2VybmFtZT5yb290PC91c2VybmFtZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxncm91cG5hbWU+cm9vdDwvZ3JvdXBuYW1lPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNvdXJjZXM+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNvdXJjZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxvY2F0aW9uPi90bXAvZ2VuZXNpc19QUk9EVUNUX3dlYi50YXIuZ3o8L2xvY2F0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc291cmNlPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zb3VyY2VzPgogICAgICAgICAgICAgICAgICAgICAgICA8L21hcHBpbmc+CiAgICAgICAgICAgICAgICAgICAgPC9tYXBwaW5ncz4KICAgICAgICAgICAgICAgIDwvY29uZmlndXJhdGlvbj4KICAgICAgICAgICAgPC9wbHVnaW4+CiAgICAgICAgPC9wbHVnaW5zPgogICAgPC9idWlsZD4KPC9wcm9qZWN0Pg==" | base64 -d > pom.xml
                    sed -i "s/PRODUCT/$PRODUCT_NAME/g" pom.xml
                    if [ $(test -f /tmp/install.sh && echo 1 || echo 0) -eq 1  ]
                    then
                      rm /tmp/install.sh
                    fi
                    echo "IyEvdXNyL2Jpbi9lbnYgYmFzaAoKZXhlYyAxPi9wcm9jLyRQUElEL2ZkLzEKZXhlYyAyPi9wcm9jLyRQUElEL2ZkLzIKCmVjaG8gIlNUQVJUSU5HIiA+IC90bXAvZ2VuZXNpc19pbnN0YWxsYXRpb25fc3RhdHVzCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyMgRnVuY3Rpb25zICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwpnZW5lc2lzX2lzX3J1bm5pbmcoKSB7CiAgICAjIEdldCB0aGUga2V5d29yZCB0byBzZWFyY2ggZm9yCiAgICBsb2NhbCBrZXl3b3JkPSJnbG9iYWwuZ2VuZXNpcyIKCiAgICAjIFVzZSBwcyBhbmQgZ3JlcCB0byBzZWFyY2ggZm9yIHByb2Nlc3NlcwogICAgbG9jYWwgY291bnQ9JChwcyBhdXggfCBncmVwIC1jICIka2V5d29yZCIpCgogICAgIyBDaGVjayB0aGUgY291bnQgb2YgbWF0Y2hpbmcgcHJvY2Vzc2VzCiAgICBpZiBbWyAkY291bnQgLWd0IDEgXV07IHRoZW4KICAgICAgICByZXR1cm4gMCAgIyB0cnVlCiAgICBlbHNlCiAgICAgICAgcmV0dXJuIDEgICMgZmFsc2UKICAgIGZpCn0KCmdlbmVzaXNfaXNfaW5zdGFsbGVkKCkgewogICAgaWYgWyAtZCAvaG9tZS8iJGdlbmVzaXNfdXNlciIvcnVuL2dlbmVyYXRlZCBdOyB0aGVuCiAgICAgICAgcmV0dXJuIDAgIyB0cnVlCiAgICBlbHNlCiAgICAgICAgcmV0dXJuIDEgIyBmYWxzZQogICAgZmkKfQoKZ2V0X292ZXJyaWRlX3ZhbHVlKCkgewogICAgbG9jYWwgb3ZlcnJpZGVfa2V5PSQxCiAgICBsb2NhbCBkZWZhdWx0X3ZhbHVlPSQyCgogICAgaWYgWyAtZiAvdG1wL2dlbmVzaXNfaW5zdGFsbC5jb25mIF0gJiYgZ3JlcCAtLXF1aWV0IC1pICIkb3ZlcnJpZGVfa2V5PS4qIiAvdG1wL2dlbmVzaXNfaW5zdGFsbC5jb25mOyB0aGVuCiAgICAgICAgZ3JlcCAtaSAiXiRvdmVycmlkZV9rZXk9IiAiL3RtcC9nZW5lc2lzX2luc3RhbGwuY29uZiIgfCBzZWQgInMvXiRvdmVycmlkZV9rZXk9Ly8iCiAgICBlbHNlCiAgICAgICAgZWNobyAkZGVmYXVsdF92YWx1ZQogICAgZmkKfQoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKIyMgU2V0IHRoZSBwcm9kdWN0IHVzZXIgYW5kIGdyb3VwIGlmIHNwZWNpZmllZAoKZ2VuZXNpc191c2VyPSQoZ2V0X292ZXJyaWRlX3ZhbHVlICJnZW5lc2lzX3VzZXIiICJnZW5lc2lzVXNlciIpCmdlbmVzaXNfZ3JwPSQoZ2V0X292ZXJyaWRlX3ZhbHVlICJnZW5lc2lzX2dycCIgImdlbmVzaXNVc2VyIikKcm9vdF9kaXI9JChnZXRfb3ZlcnJpZGVfdmFsdWUgInJvb3RfZGlyIiAiZGF0YSIpCmRiX2JhY2t1cD0kKGdldF9vdmVycmlkZV92YWx1ZSAiZGJfYmFja3VwIiAidHJ1ZSIpCnJ1bl9nZW5lc2lzX2luc3RhbGw9JChnZXRfb3ZlcnJpZGVfdmFsdWUgInJ1bl9nZW5lc2lzX2luc3RhbGwiICJ0cnVlIikKcnVuX2dlbmVzaXNfY2xlYXJfY29kZWdlbl9jYWNoZT0kKGdldF9vdmVycmlkZV92YWx1ZSAicnVuX2dlbmVzaXNfY2xlYXJfY29kZWdlbl9jYWNoZSIgInRydWUiKQpydW5fZ2VuZXNpc19yZW1hcD0kKGdldF9vdmVycmlkZV92YWx1ZSAicnVuX2dlbmVzaXNfcmVtYXAiICJ0cnVlIikKc3RhcnRfcHJvY2Vzc2VzPSQoZ2V0X292ZXJyaWRlX3ZhbHVlICJzdGFydF9wcm9jZXNzZXMiICJ0cnVlIikKc2tpcF9pbnN0YWxsX2hvb2tzPSQoZ2V0X292ZXJyaWRlX3ZhbHVlICJza2lwX2luc3RhbGxfaG9va3MiICJmYWxzZSIpCndlYl9wYXRoPSQoZ2V0X292ZXJyaWRlX3ZhbHVlICJ3ZWJfcGF0aCIgIi8kcm9vdF9kaXIvJGdlbmVzaXNfdXNlci93ZWIiKQoKcnVuX2V4ZWM9JChnZXRfb3ZlcnJpZGVfdmFsdWUgInJ1bl9leGVjIiAidHJ1ZSIpCgppZiBbICRydW5fZXhlYyA9ICJmYWxzZSIgXTsgdGhlbgogICAgcnVuX2dlbmVzaXNfaW5zdGFsbD0iZmFsc2UiCiAgICBydW5fZ2VuZXNpc19yZW1hcD0iZmFsc2UiCiAgICBzdGFydF9wcm9jZXNzZXM9ImZhbHNlIgpmaQoKc2VydmVyX2Rpcj0kKGRhdGUgKyVZJW0lZC0lSCVNKQoKIyBDcmVhdGUgaW5zdGFsbCBsb2cKTE9HPS9ob21lLyRnZW5lc2lzX3VzZXIvZ2VuZXNpc0luc3RhbGxfJHNlcnZlcl9kaXIubG9nCmVjaG8gIkdlbmVzaXMgJGdlbmVzaXNfdXNlciBJbnN0YWxsIHN0YXJ0ZWQgYXQgJChkYXRlKSIgMj4mMSB8IHRlZSAtYSAiJExPRyIKY2hvd24gIiRnZW5lc2lzX3VzZXIiLiIkZ2VuZXNpc19ncnAiICIkTE9HIgplY2hvICJDcmVhdGUgaW5zdGFsbCBsb2cuLiIKCmlmIFsgISAtZCAvdmFyL2xvZy9nZW5lc2lzX3NlcnZpY2UgXTsgdGhlbgogICAgc3VkbyBpbnN0YWxsIC1kIC92YXIvbG9nL2dlbmVzaXNfc2VydmljZSAtbyAkZ2VuZXNpc191c2VyIC1tIDc1MAplbHNlCiAgICBlY2hvICIvdmFyL2xvZy9nZW5lc2lzX3NlcnZpY2UgaXMgYWxyZWFkeSBwcmVzZW50IgpmaQoKZWNobyAiZ2VuZXNpc191c2VyIGlzOiAkZ2VuZXNpc191c2VyIiAyPiYxIHwgdGVlIC1hICIkTE9HIgplY2hvICJ1c2VyIGdyb3VwIGlzICRnZW5lc2lzX2dycCIgMj4mMSB8IHRlZSAtYSAiJExPRyIKZWNobyAiaW5zdGFsbGF0aW9uIGRpcmVjdG9yeSBpczogJGdlbmVzaXNfdXNlciIgMj4mMSB8IHRlZSAtYSAiJExPRyIKCgojQ3JlYXRlIGdlbmVzaXMgdXNlciBpZiBkb2Vzbid0IGV4aXN0CmVjaG8gIkNyZWF0ZSAkZ2VuZXNpc191c2VyIGlmIGRvZXNuJ3QgZXhpc3QiCmlmIFsgISAtZCAvaG9tZS8kZ2VuZXNpc191c2VyIF07IHRoZW4KICAgIGVjaG8gIkNyZWF0aW5nICRnZW5lc2lzX3VzZXIgLi4uLiAiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICBzdWRvIGFkZHVzZXIgLW0gIiRnZW5lc2lzX3VzZXIiCiAgICBlY2hvICIkZ2VuZXNpc191c2VyIiIgICAgICAgICAgc29mdCAgICAgbnByb2MgICAgICAgICAgMTYzODQiIHwgc3VkbyB0ZWUgLWEgL2V0Yy9zZWN1cml0eS9saW1pdHMuY29uZgogICAgZWNobyAiJGdlbmVzaXNfdXNlciIiICAgICAgICAgIGhhcmQgICAgIG5wcm9jICAgICAgICAgIDE2Mzg0IiB8IHN1ZG8gdGVlIC1hIC9ldGMvc2VjdXJpdHkvbGltaXRzLmNvbmYKICAgIGVjaG8gIiRnZW5lc2lzX3VzZXIiIiAgICAgICAgICBzb2Z0ICAgICBub2ZpbGUgICAgICAgICA2NTUzNiIgfCBzdWRvIHRlZSAtYSAvZXRjL3NlY3VyaXR5L2xpbWl0cy5jb25mCiAgICBlY2hvICIkZ2VuZXNpc191c2VyIiIgICAgICAgICAgaGFyZCAgICAgbm9maWxlICAgICAgICAgNjU1MzYiIHwgc3VkbyB0ZWUgLWEgL2V0Yy9zZWN1cml0eS9saW1pdHMuY29uZgplbHNlCiAgICBlY2hvICJVc2VyIHByZXNlbnQuIENhcnJ5aW5nIG9uIC4uICAiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmZpCgojIEJhY2t1cCBrZXlzIHRvIC90bXAva2V5cy8KaWYgWyAtZCAvaG9tZS8kZ2VuZXNpc191c2VyL3J1bi9ydW50aW1lL2tleXMgXTsgdGhlbgogICAgZWNobyAiRGlyZWN0b3J5IGtleXMgZXhpc3RzIGluIHJ1bnRpbWUuIiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICAgZWNobyAiTW92aW5nIGtleXMgdG8gL3RtcC8iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICBjcCAtciAvaG9tZS8iJGdlbmVzaXNfdXNlciIvcnVuL3J1bnRpbWUva2V5cyAvdG1wLwpmaQoKIyBraWxsIHNlcnZlcgppZiBnZW5lc2lzX2lzX3J1bm5pbmc7IHRoZW4KICAgIGVjaG8gIkRldGVjdGVkIEdlbmVzaXMgcHJvY2Vzc2VzIHJ1bm5pbmcsIGF0dGVtcHRpbmcgdG8ga2lsbCB0aGVtLi4uIiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICAgaWYgZ2VuZXNpc19pc19pbnN0YWxsZWQ7IHRoZW4KICAgICAgICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnZWNobyB5IHwga2lsbFNlcnZlciAtLWFsbCcKICAgICAgICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnZWNobyB5IHwga2lsbERhZW1vbicKICAgIGVsc2UKICAgICAgICBlY2hvICJHZW5lc2lzIGRvZXNuJ3Qgc2VlbSB0byBiZSBpbnN0YWxsZWQsIHdlIHdpbGwgdHJ5IGFuZCBzdG9wIHRoZSBwcm9jZXNzZXMgYWZ0ZXIgdGhlIG5ldyBpbnN0YWxsYXRpb24iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICBmaQpmaQoKI0JhY2t1cCB0aGUgZGF0YWJhc2UgYWNjb3JkaW5nIHRvIHRoZSBjb25maWcKZWNobyAiQmFja3VwIGlmIEdlbmVzaXMgaXMgaW5zdGFsbGVkIHVubGVzcyB0b2xkIG90aGVyd2lzZS4iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmlmIFsgIiRkYl9iYWNrdXAiID0gInRydWUiIF0gJiYgZ2VuZXNpc19pc19pbnN0YWxsZWQ7IHRoZW4KICAgIGVjaG8gImRiX2JhY2t1cCBpcyB0cnVlIiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICAgbWtkaXIgLXAgIi8kcm9vdF9kaXIvJGdlbmVzaXNfdXNlci9kYmJhY2t1cC8kc2VydmVyX2RpciIgfHwgZXhpdCAxCiAgICBjaG93biAtUiAiJGdlbmVzaXNfdXNlcjokZ2VuZXNpc19ncnAiICIvJHJvb3RfZGlyLyRnZW5lc2lzX3VzZXIvZGJiYWNrdXAvIiB8fCBleGl0IDEKICAgIHJ1bnVzZXIgLWwgIiRnZW5lc2lzX3VzZXIiIC1jICJjZCAvJHJvb3RfZGlyLyRnZW5lc2lzX3VzZXIvZGJiYWNrdXAvJHNlcnZlcl9kaXI7SnZtUnVuIGdsb2JhbC5nZW5lc2lzLmVudmlyb25tZW50LnNjcmlwdHMuRHVtcFRhYmxlIC0tYWxsO2d6aXAgKiIgfHwgZXhpdCAxCmVsc2UKICAgIGVjaG8gImRiX2JhY2t1cCBpcyBmYWxzZSBpbiAvdG1wL2dlbmVzaXNfaW5zdGFsbC5jb25mIG9yIC90bXAvZ2VuZXNpc19pbnN0YWxsLmNvbmYgaXMgbm90IGRlZmluZWQiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmZpCgojIEV4dHJhY3QgZGlyZWN0b3J5IHN0cnVjdHVyZQplY2hvICJleHRyYWN0IHRoZSBzZXJ2ciBkaXJlY3Rvcnkgc3RydWN0dXJlIiAyPiYxIHwgdGVlIC1hICIkTE9HIgpta2RpciAtcCAiLyRyb290X2Rpci8kZ2VuZXNpc191c2VyL3NlcnZlci8kc2VydmVyX2Rpci9ydW4iIHx8IGV4aXQgMQpjZCAiLyRyb290X2Rpci8kZ2VuZXNpc191c2VyL3NlcnZlci8kc2VydmVyX2Rpci9ydW4vIiB8fCBleGl0IDEKdGFyIC14ZiAvdG1wL2dlbmVzaXNfcHJvZHVjdF9uYW1lX3BhY2thZ2UudGFyLmd6ICY+IC9kZXYvbnVsbCB8fCBleGl0IDEKcm0gLWYgL3RtcC9nZW5lc2lzX3Byb2R1Y3RfbmFtZV9wYWNrYWdlLnRhci5neiB8fCBleGl0IDEKCiNjb3B5IHJ1bnRpbWUKZWNobyAiQmFja3VwIGFuZCBjb3B5IHRoZSBleGlzdGluZyBydW50aW1lIGZyb20gcHJldmlvdXMgaW5zdGFsbGF0aW9ucywgaWYgYW55Li4uLiIgMj4mMSB8IHRlZSAtYSAiJExPRyIKaWYgWyAtZCAiL2hvbWUvJGdlbmVzaXNfdXNlci9ydW4vcnVudGltZSIgXTsgdGhlbgogICAgY3AgLVIgIi9ob21lLyRnZW5lc2lzX3VzZXIvcnVuL3J1bnRpbWUiICIvJHJvb3RfZGlyLyRnZW5lc2lzX3VzZXIvc2VydmVyLyRzZXJ2ZXJfZGlyL3J1bi8iIHx8IGV4aXQgMQpmaQoKZWNobyAiVW5saW5rIHByZXZpb3VzIHJ1biBhbmQgbGluayBpdCB0byB0aGUgcnVuIGRpciBvZiB0aGUgY3VycmVudCBpbnN0YWxsYXRpb24iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmlmIFsgLUwgIi9ob21lLyRnZW5lc2lzX3VzZXIvcnVuIiBdOyB0aGVuCiAgICB1bmxpbmsgIi9ob21lLyRnZW5lc2lzX3VzZXIvcnVuIiB8fCBleGl0IDEKZmkKbG4gLXMgIi8kcm9vdF9kaXIvJGdlbmVzaXNfdXNlci9zZXJ2ZXIvJHNlcnZlcl9kaXIvcnVuLyIgIi9ob21lLyRnZW5lc2lzX3VzZXIvcnVuIiB8fCBleGl0IDEKY2hvd24gLVIgIiRnZW5lc2lzX3VzZXI6JGdlbmVzaXNfZ3JwIiAiL2hvbWUvJGdlbmVzaXNfdXNlci9ydW4iIHx8IGV4aXQgMQoKI0NvcHkgd2ViIGlmIGV4aXN0cwplY2hvICJDaGVjayBpZiB3ZWIgaXMgYmVpbmcgZGVwbG95ZWQgLi4uIiAyPiYxIHwgdGVlIC1hICIkTE9HIgppZiBbIC1mICIvdG1wL2dlbmVzaXNfcHJvZHVjdF9uYW1lX3dlYi50YXIuZ3oiIF07IHRoZW4KICAgIGVjaG8gIldlYiBpcyBiZWluZyBkZXBsb3llZCB0b28gLi4uICIgMj4mMSB8IHRlZSAtYSAiJExPRyIKICAgIG1rZGlyIC1wICIvJHJvb3RfZGlyLyRnZW5lc2lzX3VzZXIvd2ViLSRzZXJ2ZXJfZGlyIiB8fCBleGl0IDEKICAgIGNkICIvJHJvb3RfZGlyLyRnZW5lc2lzX3VzZXIvd2ViLSRzZXJ2ZXJfZGlyIiB8fCBleGl0IDEKICAgIHRhciAteGYgL3RtcC9nZW5lc2lzX3Byb2R1Y3RfbmFtZV93ZWIudGFyLmd6ICY+IC9kZXYvbnVsbCB8fCBleGl0IDEKICAgIGVjaG8gIlVubGluayBvbGQgd2ViIGluc3RhbGxhdGlvbiBhbmQgcG9pbnQgaXQgdG8gdGhlIG5ldyB3ZWIgZm9sZGVyIiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICAgaWYgWyAtTCAkd2ViX3BhdGggXTsgdGhlbgogICAgICAgIHVubGluayAkd2ViX3BhdGggfHwgZXhpdCAxCiAgICBmaQogICAgbG4gLXMgIi8kcm9vdF9kaXIvJGdlbmVzaXNfdXNlci93ZWItJHNlcnZlcl9kaXIvIiAkd2ViX3BhdGggfHwgZXhpdCAxCiAgICBybSAtZiAvdG1wL2dlbmVzaXNfcHJvZHVjdF9uYW1lX3dlYi50YXIuZ3ogfHwgZXhpdCAxCmZpCmNob3duIC1SICIkZ2VuZXNpc191c2VyOiRnZW5lc2lzX2dycCIgIi8kcm9vdF9kaXIvJGdlbmVzaXNfdXNlciIgfHwgZXhpdCAxCgojIFNldCB1cCBiYXNocmMKZWNobyAiU2V0dGluZyB1cCBiYXNocmMgZm9yIHRoZSAkZ2VuZXNpc191c2VyIGlmIGl0cyBub3QgcHJlc2VudCIgMj4mMSB8IHRlZSAtYSAiJExPRyIKaWYgZ3JlcCAtLXF1aWV0IEdFTkVTSVNfSE9NRSAtaWMgIi9ob21lLyRnZW5lc2lzX3VzZXIvLmJhc2hyYyI7IHRoZW4KICAgIGVjaG8gImJhc2hyYyBhbHJlYWR5IHNldCIKZWxzZQogICAgewogICAgICAgIGVjaG8gImV4cG9ydCBHRU5FU0lTX0hPTUU9XCRIT01FL3J1bi8iCiAgICAgICAgZWNobyAiWyAtZiBcJEdFTkVTSVNfSE9NRS9nZW5lc2lzL3V0aWwvc2V0dXAuc2ggXSAmJiBzb3VyY2UgXCRHRU5FU0lTX0hPTUUvZ2VuZXNpcy91dGlsL3NldHVwLnNoIgogICAgICAgIGVjaG8gImV4cG9ydCBHUk9PVllfSE9NRT0vb3B0L2dyb292eSIKICAgICAgICBlY2hvICJQQVRIPVwkR1JPT1ZZX0hPTUUvYmluOlwkUEFUSCIKICAgIH0gPj4gL2hvbWUvIiRnZW5lc2lzX3VzZXIiLy5iYXNocmMgfHwgZXhpdCAxCiAgICBlY2hvICJiYXNocmMgc2V0dXAgY29tcGxldGUuLi4iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmZpCgppZiBbICRydW5fZ2VuZXNpc19jbGVhcl9jb2RlZ2VuX2NhY2hlID0gInRydWUiIF07IHRoZW4KICAgICMgUnVuIGNvbW1hbmQgdG8gY2xlYXIgY2FjaGUKICAgIGlmIGdlbmVzaXNfaXNfaW5zdGFsbGVkOyB0aGVuCiAgICAgICAgZWNobyAiUnVubmluZyBHZW5lc2lzIGNhY2hlIGNsZWFyIGNvbW1hbmQiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgaWYgd2hpY2ggQ2xlYXJDb2RlZ2VuQ2FjaGUgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgICAgIHJ1bnVzZXIgLWwgIiRnZW5lc2lzX3VzZXIiIC1jICJDbGVhckNvZGVnZW5DYWNoZSIKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJ1bnVzZXIgLWwgIiRnZW5lc2lzX3VzZXIiIC1jICJKdm1SdW4gLW1vZHVsZXM9Z2VuZXNpcy1lbnZpcm9ubWVudCBnbG9iYWwuZ2VuZXNpcy5lbnZpcm9ubWVudC5zY3JpcHRzLkNsZWFyQ29kZWdlbkNhY2hlIgogICAgICAgIGZpCiAgICBmaQpmaQoKaWYgWyAkcnVuX2dlbmVzaXNfaW5zdGFsbCA9ICJ0cnVlIiBdOyB0aGVuCiAgICAjIFJ1biBnZW5lc2lzSW5zdGFsbAogICAgZWNobyAiUnVubmluZyBHZW5lc2lzIEluc3RhbGwgc2NyaXB0IiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICAgaWYgWyAkc2tpcF9pbnN0YWxsX2hvb2tzID0gInRydWUiIF07IHRoZW4KICAgICAgICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnZ2VuZXNpc0luc3RhbGwgLS1pZ25vcmVIb29rcycKICAgIGVsc2UKICAgICAgICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnZ2VuZXNpc0luc3RhbGwnCiAgICBmaQogICAgaW5zdGFsbF9lcnJvcl9jb2RlPSQ/CiAgICBpZiBbICRpbnN0YWxsX2Vycm9yX2NvZGUgLW5lIDAgXTsgdGhlbgogICAgICAgIGVjaG8gIkdlbmVzaXMgJGdlbmVzaXNfdXNlciBnZW5lc2lzSW5zdGFsbCBoYXMgZmFpbGVkIGF0ICQoZGF0ZSkiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgZXhpdCAxCiAgICBmaQogICAgZWNobyAiR2VuZXNpcyAkZ2VuZXNpc191c2VyIGdlbmVzaXNJbnN0YWxsIGZpbmlzaGVkIGF0ICQoZGF0ZSkiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCgogICAgIyBraWxsIHNlcnZlcgogICAgaWYgZ2VuZXNpc19pc19ydW5uaW5nOyB0aGVuCiAgICAgICAgZWNobyAiRGV0ZWN0ZWQgR2VuZXNpcyBwcm9jZXNzZXMgcnVubmluZywgYXR0ZW1wdGluZyB0byBraWxsIHRoZW0uLi4iIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgaWYgZ2VuZXNpc19pc19pbnN0YWxsZWQ7IHRoZW4KICAgICAgICAgICAgcnVudXNlciAtbCAiJGdlbmVzaXNfdXNlciIgLWMgJ2VjaG8geSB8IGtpbGxTZXJ2ZXIgLS1hbGwnCiAgICAgICAgICAgIHJ1bnVzZXIgLWwgIiRnZW5lc2lzX3VzZXIiIC1jICdlY2hvIHkgfCBraWxsRGFlbW9uJwogICAgICAgIGVsc2UKICAgICAgICAgICAgZWNobyAiVW5hYmxlIHRvIHN0b3B0IHRoZSBwcm9jZXNzZXMiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgICAgIGV4aXQgMQogICAgICAgIGZpCiAgICBmaQoKICAgICMgUmVzdG9yZSBrZXlzCiAgICBpZiBbIC1kIC90bXAva2V5cyBdOyB0aGVuCiAgICAgICAgZWNobyAia2V5cyBkbyBub3QgZXhpc3QgaW4gcnVudGltZS4gUmVzdG9yaW5nIGJhY2t1cCIgMj4mMSB8IHRlZSAtYSAiJExPRyIKICAgICAgICBjcCAtciAvdG1wL2tleXMgL2hvbWUvIiRnZW5lc2lzX3VzZXIiL3J1bi9ydW50aW1lLyB8fCBleGl0IDEKICAgICAgICBlY2hvICJCYWNrdXAga2V5cyByZXN0b3JlZCwgY2xlYW5pbmcgdXAiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgcm0gLXJmIC90bXAva2V5cy8gfHwgZXhpdCAxCiAgICAgICAgY2hvd24gLVIgIiRnZW5lc2lzX3VzZXI6JGdlbmVzaXNfZ3JwIiAvaG9tZS9heGVzL3J1bi9ydW50aW1lL2tleXMgfHwgZXhpdCAxCiAgICBmaQpmaQoKaWYgWyAkcnVuX2dlbmVzaXNfcmVtYXAgPSAidHJ1ZSIgXTsgdGhlbgogICAgIyBSdW4gUmVtYXAKICAgIGVjaG8gIlJ1bm5pbmcgUmVtYXAiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnZWNobyB5IHwgcmVtYXAgLS1jb21taXQgLS1mb3JjZScKICAgIHJlbWFwX2Vycm9yX2NvZGU9JD8KICAgIGlmIFsgJHJlbWFwX2Vycm9yX2NvZGUgLW5lIDAgXTsgdGhlbgogICAgICAgIGVjaG8gIkdlbmVzaXMgJGdlbmVzaXNfdXNlciByZW1hcCBoYXMgZmFpbGVkIGF0ICQoZGF0ZSkiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCiAgICAgICAgZXhpdCAxCiAgICBmaQogICAgZWNobyAiR2VuZXNpcyAkZ2VuZXNpc191c2VyIFJQTSBpbnN0YWxsIGZpbmlzaGVkIGF0ICQoZGF0ZSkiIDI+JjEgfCB0ZWUgLWEgIiRMT0ciCmZpCgoKaWYgWyAkc3RhcnRfcHJvY2Vzc2VzID0gInRydWUiIF07IHRoZW4KICAgICNTdGFydCB0aGUgc2VydmVyCiAgICBlY2hvICIvdG1wL2dlbmVzaXNfaW5zdGFsbC5jb25mIGZpbGUgYWJzZW50IG9yIHJ1bl9leGVjIG5vdCBkZWZpbmVkIC4uLi4gU3RhcnRpbmcgc2VydmVycyAuLi4uIiAyPiYxIHwgdGVlIC1hICIkTE9HIgogICBydW51c2VyIC1sICIkZ2VuZXNpc191c2VyIiAtYyAnc3RhcnRTZXJ2ZXInCmZpCgplY2hvICJJbnN0YWxsLnNoIGhhcyBjb21wbGV0ZWQgLi4uIiAyPiYxIHwgdGVlIC1hICIkTE9HIgoKZWNobyAiQ09NUExFVEVEIiA+IC90bXAvZ2VuZXNpc19pbnN0YWxsYXRpb25fc3RhdHVzCgolY2hhbmdlbG9n" | base64 -d > /tmp/install.sh
                    sed -i "s/product_name/$PRODUCT_NAME/g" /tmp/install.sh
                    if [[ "$PRODUCT_NAME" == "wm_aqs" ]]
                    then
                        sed -i "s/genesisUser/aqs/g" /tmp/install.sh
                    else
                        sed -i "s/genesisUser/$(echo $PRODUCT_NAME | sed -E 's/[0-9]+//g')/g" /tmp/install.sh
                    fi
                    source ~/.bashrc
                    mvn versions:set -DnewVersion=$VERSION
                    mvn rpm:rpm
                    cd target/rpm/genesis-${PRODUCT_NAME}/RPMS/x86_64/${RPM_NAME}
                    curl -u ${{ secrets.JFROG_USERNAME }}:"${{secrets.JFROG_PASSWORD}}" -X PUT "https://genesisglobal.jfrog.io/artifactory/product/${{ env.PRODUCT_NAME }}/rpm/$CLIENT_NAME/" -T *.rpm
                  else
                    echo "$i is not a directory or does not have a snt folder in it"
                  fi
              cd ${{ env.PRODUCT_BASE }}
              done
